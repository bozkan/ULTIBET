<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>BETIA Live Betting</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    
    <link href="styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Jura" rel="stylesheet">
    <style type="text/css">
      ::-webkit-input-placeholder { /* WebKit, Blink, Edge */
        color:    black;
      }
      :-moz-placeholder { /* Mozilla Firefox 4 to 18 */
        color:    black;
      opacity:  1;
      }
      ::-moz-placeholder { /* Mozilla Firefox 19+ */
      color:    black;
      opacity:  1;
      }
      :-ms-input-placeholder { /* Internet Explorer 10-11 */
      color:    black;
      }
      ::-ms-input-placeholder { /* Microsoft Edge */
      color:    black;
      }

      ::placeholder { /* Most modern browsers support this now. */
      color:    black;
      }

      button {
        background-color:#5bba5c;
      }

      button:hover {
        background-color:#68d869;
      }

      .no-hover {
        color:#00c7ff;
      }

      .no-hover:hover {
        color:#0087ff;
        text-decoration: none;
      }

      .playnow:hover {
        background-color: white;
      }

      option {
        font-family: 'Jura';
      }

      h6 {
        font-size:19pt;
      }

      /* The Modal (background) */
      .modal {
          display: none; /* Hidden by default */
          position: fixed; /* Stay in place */
          z-index: 2; /* Sit on top */
          padding-top: 200px; /* Location of the box */
          left: 0;
          top: 0;
          width: 100%; /* Full width */
          height: 100%; /* Full height */
          overflow: auto; /* Enable scroll if needed */
          background-color: rgb(0,0,0); /* Fallback color */
          background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      }

      /* Modal Content */
      .modal-content2 {
          background-color: #fefefe;
          margin: auto;
          padding: 20px;
          border: 1px solid #888;
          width: 48%;
      }

      /* The Close Button */
      .close {
          color: #aaaaaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
      }

      .close:hover,
      .close:focus {
          color: #000;
          text-decoration: none;
          cursor: pointer;
      }

      .player-amount:hover {
        text-decoration: none;
      }
    </style>

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body style="padding-top:0;background-color:#1a1c1a;font-family:'Jura';color:white;">
      <div style="width:100%;font-size:15pt;padding-top:50px;" align="center"> <a href="/"><img src="/logo4.png" width="275" height="275" /></a> <br><font color="#5bba5c" style="font-size:70pt;">B</font><font color="white" style="font-size:70pt;">ETIA</font><br><font style="font-size:15pt;">A truly peer-to-peer betting platform</font></div>
      
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>

    <script>
      var socket = io();

      var $_GET = {};
      if(document.location.toString().indexOf('?') !== -1) {
          var query = document.location
                        .toString()
                        .replace(/^.*?\?/, '')
                        .replace(/#.*$/, '')
                        .split('&');

          for(var i=0, l=query.length; i<l; i++) {
            var aux = decodeURIComponent(query[i]).split('=');
            $_GET[aux[0]] = aux[1];
          }
      }

      function playnow()
      {
        $("#playarea").show()
        $("#playnow_button").hide()
        $("html, body").animate({ scrollTop: $(document).height() }, 1000);
      }

      function modalf(eventid,amount) {
          $("#modal").fadeIn()
        }

      function statement() {
        document.getElementById("statement").style.display = "block"
        socket.emit('ask account statement', $("#register").val())
      }

      function register(username) {
        document.getElementById("register_overlay").style.display = "block"
        $("#r_username").val(username)
      }

        $(function () {
          var span = document.getElementsByClassName("close")[0];
          var span2 = document.getElementsByClassName("close")[1];
          var span3 = document.getElementsByClassName("close")[2];

          // When the user clicks on <span> (x), close the modal
          span.onclick = function() {
             document.getElementById('modal').style.display = "none";
          }

          span2.onclick = function() {
            document.getElementById('statement').style.display = "none";
          }

          span3.onclick = function() {
            document.getElementById('register_overlay').style.display = "none";
          }

          // When the user clicks anywhere outside of the modal, close it
          window.onclick = function(event) {
              if (event.target == modal || 
              event.target == document.getElementById("statement") ||
              event.target == document.getElementById('register_overlay')
               ) {
                document.getElementById('modal').style.display = "none";
                document.getElementById('statement').style.display = "none";
                document.getElementById('register_overlay').style.display = "none";
              }
          }

          $('#register_form').submit(function(){
            if (/^[a-z0-9]+$/i.test($('#register').val()))
              register($('#register').val())
            else
              alert('Only letters and numbers allowed in username');
            return false
          });

          $('#send_register').submit(function(){
            if ($('#r_password').val().length < 8)
            {
              alert('Password must be at least 8 characters long')
              return false
            }
            if ($('#r_copykeys').is(':checked'))
              var copykeys = true
            else
              var copykeys = false
            socket.emit('user register', $('#r_username').val(), $('#r_password').val(), copykeys)
            return false
          });

          if ($_GET['r'])
          {
            $("#playarea").show()
            $("#register_form").hide()
            $("html, body").animate({ scrollTop: $(document).height() }, 1);
          }

          $('#create').submit(function(){
            if (/^[a-z0-9]+$/i.test($('#servername').val()) && /^[a-z0-9]+$/i.test($('#gameid').val()) && /^[a-z0-9]+$/i.test($('#coinbase').val()))
              socket.emit('create game', $('#servername').val(), parseInt($('#gameid').val()), $('#roompassword').val());
            else
              alert("Please fill in all the fields properly. Only alphanumeric characters allowed.")
          });

          socket.on('receive player counts', function(serverToPlayers){
            for (var key in serverToPlayers)
            {
                $("#count"+key).html(serverToPlayers[key].length)
            }
          })

          socket.on('error message', function (message) {
            alert(message)
          })

          socket.on('receive key container', function (cipher) {
            var uri = 'data:text;charset=utf-8,' + encodeURI(cipher)

            var downloadLink = document.createElement("a")
            downloadLink.href = uri
            downloadLink.download = "BETIA_encrypted_keys.txt"

            document.body.appendChild(downloadLink)
            downloadLink.click()
            document.body.removeChild(downloadLink)
            location.reload()
          })

          socket.on('receive account statement', function(balance, history) {
            $("#statement_balance").html("$"+balance)
            $("#statement_history").empty()
            history.forEach(function(el) {
              $("#statement_history").append("Server: "+el.server+"<br>Game id: "+el.matchid+"<br>Event: "+el.event+"<br>Amount: "+el.amount+"<hr>")
            })
          })

          socket.on('receive live match', function (match) {
              $('#gameid').append($("<option></option>").attr("value",match.matchid).text(match.hometeam+" vs. "+match.awayteam))
          })

          socket.emit('get player counts')
          socket.emit('get live matches')

          if ("<%= servers %>".length == 0)
          {
            var p_servers = [];
          }
          else
          {
            var p_servers = "<%= servers %>".split(",");
          }

          if (p_servers.length < 1)
          {
            $("#serverlist").append('No rooms currently online.')
          }
          else
          {
            for (var i = 0, n = p_servers.length; i < n; i++)
            {
              $("#serverlist").append('<a href="/play?server='+p_servers[i]+'" class="no-hover"><li class="list-group-item d-flex justify-content-between align-items-center light-hover" style="border-radius:0;background-color:#2b3038;">'+p_servers[i]+'<span class="badge badge-primary badge-pill player-amount" id="count'+p_servers[i]+'">0</span></li></a>');
            }
          }

        });
      </script>
  <br>
  <div align="center"><button type="submit" id="playnow_button" style="border-color:#5bba5c;border:0;font-size:20pt;padding:10px;cursor:pointer;margin:0;margin-top:10px;" onclick="playnow()" />Play now</button></div>
    
  <br><br>
  <div class="container" id="playarea" style="position:relative;display:none;" align="center">
      <center><form id="register_form" method="GET" action="/"><input type="text" id="register" placeholder="username" style="padding:2px;padding-left:5px;height:35px;" /> <input type="hidden" value="y" name="r" /><button type="submit" style="border-color:#5bba5c;border:0;height:35px;cursor:pointer;" />Register!</button> <button type="button" onclick="statement()" style="border-color:#5bba5c;border:0;height:35px;cursor:pointer;margin-top:15px;">Wallet</button></form></center>
        <br><br>
        <button type="button" class="btn btn-primary" style="border-radius: 0;cursor:pointer;" onclick="modalf();">Create New Room</button>
        <br><br><br>
        <h2>Online Rooms</h2>
        <br>
        <ul class="list-group" id="serverlist" style="width:50%;margin-bottom:100px;">
        </ul>
    </div>

    <div id="modal" class="modal" style="border-radius: 0;">
        <div class="modal-content2" style="color:black;">
          <span class="close">&times;</span>
          <center>
              <h2>Create Room</h2>
              <br>
              <form id="create" method="GET" action="/">
                  <div class="form-group">
                      <input type="text" class="form-control" id="servername" name="servername" placeholder="room name">
                      <select id="gameid" style="margin-top:5px;width:100%;font-family:'Jura';">
                          <option value="def;;ault">Select Match</option>
                          <option value="52419">Testing vs. Test</option>
                      </select>
                      <input type="password" placeholder="password" class="form-control" id="roompassword" style="margin-top:5px;" />
                      <small id="emailHelp" class="form-text text-muted">Leave password field empty to create a public room.</small>
                      <input type="hidden" name="r" value="y" />
                  </div>
                  <button type="submit" style="border-color:#5bba5c;border:0;height:35px;cursor:pointer;" />Create!</button>
              </form>
          </center>
        </div>
      </div>  

      <div id="statement" class="modal">
        <div class="modal-content2" style="color:black;">
          <span class="close">&times;</span>
          <center>
              <h6>Wallet</h6>
              <div id="statement_balance"></div>
              <div id="statement_history"></div>
              <br>
              <button type="button" style="border-color:#5bba5c;border:0;height:35px;cursor:pointer;margin-top:15px;">Add money</button>
          </center>
        </div>
      </div> 

      <div id="register_overlay" class="modal">
        <div class="modal-content2" style="color:black;">
          <span class="close">&times;</span>
          <center>
              <h6>Register account</h6>
              <br>
              <form method="GET" action="/" id="send_register">
              <input type="text" id="r_username" placeholder="username" class="form-control" disabled/>
              <input type="password" id="r_password" placeholder="password" class="form-control" /><br>
              <input type="checkbox" id="r_copykeys" /><label for="r_copykeys">Check this if you want us to store a copy of your private keys. This will let us sign your bets when you don't have access to your keys or send them to you if you lose them. 
                In either case, you will receive a container with your keys upon registration. 
                The keys will be encrypted with your password.
              </label>
              <br>
              <button type="submit" style="border-color:#5bba5c;border:0;height:35px;cursor:pointer;margin-top:15px;">Register!</button>
              </form>
          </center>
        </div>
      </div> 

  </body>
</html>

